= Managing Namespaces with Red hat GitOps
:toc:

In diesem Repository befinden sich Möglichkeiten, um Namespaces mit Red Hat GitOps zu managen.

== Vorwort

Grundsätzlich kann man Namespaces mit Red Hat GitOps erstellen. Entweder, insbesondere bei einer älteren Operatorversion, indem man diese als Ressource in einer YAML-Datei deklariert und diese mit Red Hat GitOps ausrollte oder, bei einer neuen Operatorversion, indem man die Erstellung des Namespaces einfach in der Syncoptionen der Argo-Application angibt. Der Unterschied zwischen den Operatorversionen ist, dass man nur in den neuen bei der Syncoption auch Labels und Annotations direkt mitgeben kann, diese aber wichtig sind, damit der Namespace anschließend auch von Red Hat GitOps verwaltet werden kann, da die Berechtigung über ein Label gesetzt werden.

In der Regel haben wir aber getrennte Gruppen, welche auf einem OpenShift Server unterwegs sind. Das sind einerseits die Clusteradministratoren und andererseits die Developerteams.

Problematisch kann es nun werden, wenn sowohl die Clusteradministratoren als auch die Developerteams Red Hat GitOps verwenden möchten. Denn auf einmal möchten zwei verschiedene Gruppen auf die gleichen Namespaces zugreifen, um dort jeweils ihre Konfigurationen zu hinterlegen. Die Clusteradmins möchten beispielsweise Ressourcequotas, Limitranges oder Networkpolicies im Namespace konfigurieren und die Developer möchten ihrerseits natürlich Deployments, Configmaps, Routen und mehr konfigurieren.

== Option 1: Nur eine Red hat GitOps Instanz

Diese Option klingt zunächst leicht, ist sie aber nicht, da sie schwierig zu konfigurieren ist. Natürlich kann man nur eine Instanz von Red Hat GitOps installieren und dort über RBAC die Berechtigungen trennen, so dass Developerteams nur Zugriff auf ihre jeweiligen Argo-Applikationsprojekte haben.

image:pictures/oneargo.png["Nur eine Instanz"]

Das Problem lauert aber an einer anderen Stelle. Wenn wir nur eine GitOps-Instanz haben, dann haben wir auch nur einen dahinterliegenden GitOps-Serviceaccount mit den entsprechenden Berechtigungen in dem Namespace. Und wenn ein Developerteam GitOps verwendet, dann werden die Ressourcen nicht mit den Berechtigungen des Developers, sondern mit den Berechtigungen des GitOps-Serviceaccounts erstellt. Hat also der Clusteradmin die Möglichkeit, über GitOps eine Networkpolicy auszurollen, dann hat der Developer das in seinem Namespace ebenso.

Nun kann man dies noch über die Argo-Applikationsprojekte lösen, denn dort lässt sich konfigurieren, welche Art von Kubernetesonjekten wie z.B. "NetworkPolicy" erstellt werden dürfen und welche nicht. Diese Konfiguration muss aber sehr bedacht vorgenommen werden, damit am Ende die Berechtigungen korrekt sind.

Wenn man jedoch unterschiedliche Instanzen von Red Hat GitOps einsetzen möchte oder dies gar eine Compliance- oder Securityanforderung ist, muss man anders vorgehen. Hierfür sind die beiden folgenden Optionen gedacht.

== Option 2: Getrennte Instanzen und Konfiguration der Instanzberechtigungen

Wenn man getrennte Instanzen von Red Hat GitOps einsetzt, stösst man auf ein Problem. Über ein Label "argocd.argoproj.io/managed-by:" wird in einem Namespace angegeben, welche Instanz diesen Namespace verwaltet. Daher hat erst einmal nur eine Instanz von Red Hat GitOps die Berechtigung, auf den Namespace zuzugreifen.

Hinweis: Diese Option habe ich bisher nicht getestet, es dürfte aber keine technischen Probleme geben.

Wenn man nun beide Instanzen berechtigen möchte, auf einen Namespace zuzugreifen, muss man wissen, was hinter den Kulissen passiert, wenn ein Namespace ein entsprechendes Label erhält.

image:pictures/berechtigungsprozess3.png["Berechtigungsprozess"]

Wenn ein Namespace mit dem entsprechenden Label erstellt wird, bermerkt GitOps dies und erstellt im Normalfall eine Rolle und ein Rolebinding für den Serviceaccount des ArgoCD-Application-Controllers. Diese beiden Ressourcen sind an den Namespace gebunden, so dass GitOps darüber Zugriff auf den Namespace erhält.

Diese Rolle und das Rolebinding können wir natürlich auch manuell erstellen, also mit GitOps ausrollen, um die gleichen Berechtigungen wie durch das Label zu erhalten. So haben wir die Möglichkeit, dass die GitOps-Instanz für die Clusteradministratoren über diesen manuellen Weg und die GitOps-Instanz der Developer über das Label im Namespace Berechtigungen auf den Namespace erhalten. (Das geht natürlich grundsätzlich auch anders herum.)

image:pictures/instanzberechtigungen2.png["Instanzberechtigungen"]



https://github.com/redhat-cop/namespace-configuration-operator

